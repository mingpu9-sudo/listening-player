<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>精听分句播放器 · 学生练习版</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937;--card:#0b1220}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
  header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  header h1{margin:0;font-size:18px}
  .muted{color:var(--muted);font-size:12px}
  main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
  @media(max-width:960px){main{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  input[type=file],select,button,input[type=text]{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:14px}
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:#1d4ed8}
  button.ghost{background:var(--card)}
  .list{max-height:60vh;overflow:auto;display:flex;flex-direction:column;gap:8px}
  .item{display:grid;grid-template-columns:70px 1fr auto;gap:8px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px}
  .item.active{outline:2px solid #3b82f6}
  .progress{height:8px;width:100%;background:var(--card);border-radius:999px;border:1px solid var(--border);overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#3b82f6)}
  textarea{width:100%;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px;line-height:1.6}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--card);border:1px solid var(--border);border-radius:6px;padding:2px 6px}
  #authModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:1000}
  #authBox{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:20px;width:400px;max-width:90vw}
  .auth-row{margin:12px 0}
  .auth-error{color:#f87171;font-size:14px;margin-top:8px}
  .completion-badge{background:#059669;color:white;padding:4px 8px;border-radius:6px;font-size:12px;margin-left:8px}
  .cloze-word{display:inline-block;margin:0 2px;min-width:20px}
  .cloze-blank{display:inline-block;width:60px;height:20px;border-bottom:2px solid #3b82f6;margin:0 2px;vertical-align:middle}
  .print-only{display:none}
</style>
</head>
<body>
<!-- 授权模态框 -->
<div id="authModal" style="display:none">
  <div id="authBox">
    <h2 style="margin-top:0">完成练习验证</h2>
    <div class="auth-row">
      <div>恭喜您已完成练习！请输入老师提供的授权码查看原文：</div>
      <input type="text" id="authCode" placeholder="输入授权码" style="width:100%;margin-top:8px"/>
    </div>
    <div class="auth-row">
      <button id="submitAuth" class="primary" style="width:100%">验证授权</button>
    </div>
    <div id="authError" class="auth-error" style="display:none">授权码错误，请重试</div>
    <div class="muted" style="margin-top:12px">提示：完成所有句子的练习后，联系老师获取授权码</div>
  </div>
</div>

<header>
  <h1>精听分句播放器 · 学生练习版</h1>
  <span class="muted">先练习后查看 · 完成所有句子后可查看原文</span>
  <div style="flex:1"></div>
  <span class="muted">快捷键：<span class="kbd">Space</span> 播放/暂停 · <span class="kbd">←/→</span> 上/下一句 · <span class="kbd">L</span> 单句循环 · <span class="kbd">A/D</span> 变速 · <span class="kbd">E</span> 导出当前</span>
</header>

<main>
  <section class="panel">
    <div class="row"><strong>练习材料加载</strong></div>
    <div class="row">
      <button id="loadDefault" class="primary">载入OrangeT1_23练习材料</button>
      <span class="muted">或</span>
      <button id="loadCustom" class="ghost">载入自定义材料</button>
    </div>

    <!-- 自定义材料上传 -->
    <div id="customSection" style="display:none">
      <div class="row"><strong>1) 选择 master 音频</strong></div>
      <input id="fileAudio" type="file" accept="audio/*,video/*"/>

      <div class="row"><strong>2) 选择 splits.csv</strong> <span class="muted">三列：start,end,label</span></div>
      <input id="fileCSV" type="file" accept=".csv,text/csv"/>

      <div class="row"><strong>3) 选择 transcript.csv（可选）</strong></div>
      <input id="fileTXT" type="file" accept=".csv,text/csv"/>
      <div class="row"><button id="loadFiles" class="primary">载入文件</button><button id="clear" class="ghost">清空</button></div>
    </div>

    <hr style="border-color:#1f2937;opacity:.4"/>
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>句子列表</strong>
      <div>
        <span class="muted" id="count">0 条</span>
        <span id="completionBadge" class="completion-badge" style="display:none">已完成</span>
      </div>
    </div>
    <div id="list" class="list"></div>
  </section>

  <section class="panel">
    <div class="row" style="justify-content:space-between">
      <div>
        <div>当前：<span id="nowLabel">—</span> <span class="muted" id="nowIdx"></span></div>
        <div class="muted">起止：<span id="nowRange">—</span></div>
      </div>
      <div class="row">
        <label class="muted">速度
          <select id="rate">
            <option value="0.7">0.7×</option>
            <option value="0.85">0.85×</option>
            <option value="1" selected>1.0×</option>
            <option value="1.2">1.2×</option>
            <option value="1.5">1.5×</option>
            <option value="2">2.0×</option>
          </select>
        </label>
        <label class="muted"><input id="loopOne" type="checkbox"> 单句循环 (L)</label>
        <label class="muted"><input id="autoNext" type="checkbox" checked> 自动下一句</label>
        <button id="requestAuth" class="primary">完成练习，查看原文</button>
        <button id="printWorksheet" class="ghost">打印挖空练习</button>
      </div>
    </div>

    <audio id="audio" controls style="width:100%;margin:10px 0 8px 0"></audio>
    <div class="progress"><div id="bar" class="bar"></div></div>

    <div class="row" style="justify-content:center;margin-top:10px;gap:12px">
      <button id="prev" class="ghost">← 上一句</button>
      <button id="toggle" class="ghost">▶︎ 播放/暂停</button>
      <button id="next" class="ghost">下一句 →</button>
      <button id="repeat3" class="ghost">重复 3 次</button>
      <button id="markComplete" class="ghost">标记本句完成</button>
      <button id="exportClip" class="ghost">导出当前句 (WAV)</button>
    </div>

    <div class="panel" id="practicePanel" style="margin-top:16px;">
      <div style="font-weight:600;margin-bottom:6px">练习区（请在下方填写您听到的内容）</div>
      <textarea id="studentAnswer" rows="6" placeholder="在这里写下您听到的句子内容..."></textarea>
      <div class="row" style="margin-top:8px;justify-content:space-between">
        <span class="muted">挖空提示：<input id="clozeLevel" type="range" min="0" max="100" value="50">（越大挖空越多）</span>
        <button id="showClozeHint" class="ghost">显示挖空提示</button>
      </div>
    </div>

    <div class="panel" id="clozePanel" style="margin-top:12px; display:none;">
      <div style="font-weight:600;margin-bottom:6px">挖空提示</div>
      <div id="clozeText" style="line-height:1.8;background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:10px;"></div>
    </div>

    <div class="panel" id="answerPanel" style="margin-top:12px; display:none;">
      <div style="font-weight:600;margin-bottom:6px">参考答案</div>
      <div id="answerText" style="line-height:1.8;background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:10px;"></div>
    </div>
  </section>
</main>

<script>
// 预设材料配置 - 根据您的仓库结构
const DEFAULT_MATERIALS = {
  audio: 'https://raw.githubusercontent.com/mingpu9-sudo/listening-player/refs/heads/main/assets/OrangeT1_23.mp3',
  splits: 'https://raw.githubusercontent.com/mingpu9-sudo/listening-player/refs/heads/main/assets/OrangeT1_23_splits.csv',
  transcript: 'https://raw.githubusercontent.com/mingpu9-sudo/listening-player/refs/heads/main/assets/OrangeT1_23_transcript.csv'
};

let segments = [];
let idx = -1;
let repeatLeft = 0;
let decodedBuffer = null;
let authorized = false; // 所有人都需要授权，包括老师
let completedSentences = new Set();

const audio = document.getElementById('audio');
const bar = document.getElementById('bar');

// 授权码验证
const validAuthCodes = ["STUDENT2024", "LISTENING123", "ENGLISH456"];

function checkAuth(code) {
  return validAuthCodes.includes(code.toUpperCase());
}

function initAuth() {
  // 移除自动授权，所有人都需要输入授权码
  authorized = false;
  
  document.getElementById('requestAuth').addEventListener('click', () => {
    if (completedSentences.size < segments.length) {
      alert(`请先完成所有句子的练习！当前进度：${completedSentences.size}/${segments.length}`);
      return;
    }
    document.getElementById('authModal').style.display = 'flex';
  });
  
  document.getElementById('submitAuth').addEventListener('click', () => {
    const code = document.getElementById('authCode').value.trim();
    if (checkAuth(code)) {
      authorized = true;
      localStorage.setItem('listeningAuth', code);
      document.getElementById('authModal').style.display = 'none';
      enableAnswerMode();
    } else {
      document.getElementById('authError').style.display = 'block';
    }
  });
  
  // 清除之前可能保存的授权
  localStorage.removeItem('listeningAuth');
}

function enableAnswerMode() {
  document.getElementById('requestAuth').style.display = 'none';
  document.getElementById('answerPanel').style.display = '';
  updateAnswerDisplay();
}

function updateCompletionStatus() {
  const total = segments.length;
  const completed = completedSentences.size;
  
  if (completed > 0) {
    document.getElementById('completionBadge').style.display = 'inline';
    document.getElementById('completionBadge').textContent = `进度: ${completed}/${total}`;
  }
  
  if (completed === total && total > 0) {
    document.getElementById('requestAuth').style.background = 'linear-gradient(180deg,#059669,#047857)';
    document.getElementById('requestAuth').textContent = '🎉 全部完成！查看原文';
  }
}

// 真正的挖空功能
function createClozeText(text, level) {
  if (!text) return '';
  
  const words = text.split(/(\s+)/);
  const ratio = Math.max(0, Math.min(1, level / 100));
  
  return words.map(word => {
    // 保留空格和标点
    if (/^\s+$/.test(word) || /^[.,!?;:]+$/.test(word)) {
      return word;
    }
    
    // 对单词进行挖空
    const chars = [...word];
    const shouldBlank = Math.random() < ratio;
    
    if (shouldBlank && chars.some(ch => /[A-Za-z]/.test(ch))) {
      return `<span class="cloze-blank" title="${word}"></span>`;
    } else {
      return `<span class="cloze-word">${word}</span>`;
    }
  }).join('');
}

function updateClozeHint() {
  const level = parseInt(document.getElementById('clozeLevel').value, 10) || 50;
  const seg = segments[idx] || {};
  const clozeText = createClozeText(seg.text, level);
  
  document.getElementById('clozeText').innerHTML = clozeText || '（此句未填写原文）';
}

// 打印挖空练习功能
function printClozeWorksheet() {
  if (!segments.length) {
    alert('请先载入练习材料');
    return;
  }
  
  const level = 50; // 固定挖空强度
  const worksheetContent = segments.map((seg, index) => {
    const clozeText = createClozeText(seg.text, level);
    return `
      <div style="margin-bottom: 20px; page-break-inside: avoid;">
        <div style="font-weight: bold; margin-bottom: 8px;">句子 ${index + 1}: ${seg.label}</div>
        <div style="line-height: 1.6; margin-bottom: 10px;">${clozeText || '（此句未填写原文）'}</div>
        <div style="border-bottom: 1px solid #ccc; padding-bottom: 15px;">答案区：________________________________</div>
      </div>
    `;
  }).join('');
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>精听挖空练习 - OrangeT1_23</title>
      <style>
        body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", sans-serif;
          margin: 20px;
          line-height: 1.4;
          color: #333;
        }
        .header {
          text-align: center;
          margin-bottom: 30px;
          border-bottom: 2px solid #2563eb;
          padding-bottom: 10px;
        }
        .cloze-blank {
          display: inline-block;
          width: 60px;
          height: 20px;
          border-bottom: 2px solid #2563eb;
          margin: 0 2px;
          vertical-align: middle;
        }
        .cloze-word {
          display: inline-block;
          margin: 0 2px;
        }
        .student-info {
          margin-bottom: 20px;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 5px;
        }
        @media print {
          body { margin: 15px; }
          .no-print { display: none; }
        }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>精听挖空练习</h1>
        <p>材料: OrangeT1_23 &nbsp;|&nbsp; 句子数量: ${segments.length} &nbsp;|&nbsp; 日期: ${new Date().toLocaleDateString()}</p>
      </div>
      
      <div class="student-info">
        <strong>学生信息：</strong>
        姓名：________________ &nbsp;&nbsp; 
        班级：________________ &nbsp;&nbsp; 
        学号：________________
      </div>
      
      ${worksheetContent}
      
      <div class="no-print" style="margin-top: 30px; text-align: center;">
        <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; background: #2563eb; color: white; border: none; border-radius: 5px; cursor: pointer;">
          打印练习册
        </button>
        <button onclick="window.close()" style="padding: 10px 20px; font-size: 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
          关闭
        </button>
      </div>
    </body>
    </html>
  `);
  printWindow.document.close();
}

// 加载默认材料
async function loadDefaultMaterials() {
  try {
    showLoading('正在载入OrangeT1_23练习材料...');
    
    // 加载音频
    audio.src = DEFAULT_MATERIALS.audio;
    
    // 解码音频
    try {
      const response = await fetch(DEFAULT_MATERIALS.audio);
      const arrayBuffer = await response.arrayBuffer();
      const AC = window.AudioContext || window.webkitAudioContext;
      const ctx = new AC();
      decodedBuffer = await ctx.decodeAudioData(arrayBuffer.slice(0));
      ctx.close && ctx.close();
    } catch(e) {
      console.warn('音频解码失败', e);
      decodedBuffer = null;
    }
    
    // 加载splits
    const csvResponse = await fetch(DEFAULT_MATERIALS.splits);
    const csvText = await csvResponse.text();
    const lines = csvText.split(/\r?\n/).filter(x => x.trim());
    const out = [];
    
    for (const line of lines) {
      const cells = line.split(',');
      if (cells.length < 3) continue;
      const start = parseTime(cells[0]);
      const end = parseTime(cells[1]);
      const label = cells.slice(2).join(',').replace(/^"|"$/g, '').trim();
      if (end > start) out.push({start, end, label, text: ''});
    }
    
    segments = out;
    
    // 加载transcript
    try {
      const txtResponse = await fetch(DEFAULT_MATERIALS.transcript);
      const txtText = await txtResponse.text();
      const lines = txtText.split(/\r?\n/).filter(x => x.trim());
      const map = new Map();
      
      const head = lines[0].toLowerCase();
      let sIdx = 0;
      if (head.includes('label') && head.includes('text')) sIdx = 1;
      
      for (let i = sIdx; i < lines.length; i++) {
        const arr = lines[i].split(',');
        if (arr.length < 2) continue;
        const label = arr[0].replace(/^"|"$/g, '').trim();
        const text = arr.slice(1).join(',').replace(/^"|"$/g, '').trim();
        map.set(label, text);
      }
      
      let filled = 0;
      for (const seg of segments) {
        if (map.has(seg.label)) {
          seg.text = map.get(seg.label);
          filled++;
        }
      }
      console.log(`已填充原文：${filled} 条`);
    } catch (e) {
      console.warn('载入transcript失败', e);
    }
    
    idx = 0;
    renderList();
    loadIndex(0);
    hideLoading();
    alert('OrangeT1_23练习材料载入成功！');
    
  } catch (error) {
    hideLoading();
    console.error('载入失败:', error);
    alert('载入失败，请检查网络连接或联系老师');
  }
}

function showLoading(message) {
  const existing = document.getElementById('loadingToast');
  if (existing) existing.remove();
  
  const toast = document.createElement('div');
  toast.id = 'loadingToast';
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: var(--panel); padding: 20px; border-radius: 10px;
    border: 1px solid var(--border); z-index: 1000;
  `;
  document.body.appendChild(toast);
}

function hideLoading() {
  const toast = document.getElementById('loadingToast');
  if (toast) toast.remove();
}

function parseTime(s){
  if(typeof s === 'number') return s; s=String(s).trim(); if(!s) return 0;
  if(/^\d+(\.\d+)?$/.test(s)) return parseFloat(s);
  const parts = s.split(':').map(parseFloat);
  if(parts.length===2){const [m,sec]=parts;return m*60+sec}
  if(parts.length===3){const [h,m,sec]=parts;return h*3600+m*60+sec}
  return 0;
}

function fmt(t){const h=Math.floor(t/3600);const m=Math.floor((t%3600)/60);const s=(t%60).toFixed(3).padStart(6,'0');return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s}`}

async function loadFiles(){
  const a=document.getElementById('fileAudio').files[0];
  const c=document.getElementById('fileCSV').files[0];
  const t=document.getElementById('fileTXT').files[0];
  
  if(!a||!c){alert('请选择 master 音频与 splits.csv');return}
  
  audio.src=URL.createObjectURL(a);
  try{const arr=await a.arrayBuffer(); const AC=window.AudioContext||window.webkitAudioContext; const ctx=new AC(); decodedBuffer=await ctx.decodeAudioData(arr.slice(0)); ctx.close&&ctx.close();}catch(e){console.warn('Decode failed',e); decodedBuffer=null}
  
  const csvText=await c.text();
  const lines=csvText.split(/\r?\n/).filter(x=>x.trim());
  const out=[];
  for(const line of lines){const cells=line.split(','); if(cells.length<3) continue; const start=parseTime(cells[0]); const end=parseTime(cells[1]); const label=cells.slice(2).join(',').replace(/^\"|\"$/g,'').trim(); if(end>start) out.push({start,end,label,text:''});}
  segments=out;
  
  if(t){
    const txtText=await t.text(); 
    const lines=txtText.split(/\r?\n/).filter(x=>x.trim()); 
    const map=new Map();
    const head=lines[0].toLowerCase(); 
    let sIdx=0; 
    if(head.includes('label')&&head.includes('text')) sIdx=1;
    for(let i=sIdx;i<lines.length;i++){const arr=lines[i].split(','); if(arr.length<2) continue; const label=arr[0].replace(/^\"|\"$/g,'').trim(); const text=arr.slice(1).join(',').replace(/^\"|\"$/g,'').trim(); map.set(label,text)}
    let filled=0; for(const seg of segments){if(map.has(seg.label)){seg.text=map.get(seg.label); filled++;}}
    alert('已填充原文：'+filled+' 条');
  }
  
  idx=0; renderList(); loadIndex(0); completedSentences.clear(); updateCompletionStatus();
}

function renderList(){
  const list=document.getElementById('list'); list.innerHTML=''; document.getElementById('count').textContent=`${segments.length} 条`;
  segments.forEach((seg,i)=>{
    const div=document.createElement('div'); 
    div.className='item'+(i===idx?' active':'');
    const completed = completedSentences.has(i) ? '✅ ' : '';
    div.innerHTML=`<span class="muted">#${String(i+1).padStart(2,'0')}</span><div>${completed}${seg.label} <span class="muted">(${fmt(seg.start)} ~ ${fmt(seg.end)})</span></div><button class="ghost">播放</button>`; 
    div.querySelector('button').addEventListener('click',()=>{loadIndex(i); play();}); 
    div.addEventListener('click',e=>{if(e.target.tagName!=='BUTTON'){loadIndex(i);}}); 
    list.appendChild(div);
  });
}

function loadIndex(i){ 
  if(i<0||i>=segments.length) return; 
  idx=i; 
  repeatLeft=0; 
  const seg=segments[idx]; 
  audio.currentTime=seg.start; 
  document.getElementById('nowLabel').textContent=seg.label; 
  document.getElementById('nowIdx').textContent=`(${idx+1}/${segments.length})`; 
  document.getElementById('nowRange').textContent=`${fmt(seg.start)} ~ ${fmt(seg.end)}`; 
  
  const studentAnswer = localStorage.getItem(`answer_${idx}`) || '';
  document.getElementById('studentAnswer').value = studentAnswer;
  
  updateAnswerDisplay();
  updateClozeHint();
  [...document.querySelectorAll('.item')].forEach((el,j)=>el.classList.toggle('active',j===idx)); 
}

function updateAnswerDisplay() {
  const seg = segments[idx] || {};
  if (authorized) {
    document.getElementById('answerText').textContent = seg.text || '（此句未填写原文）';
  } else {
    document.getElementById('answerText').textContent = '请完成练习并获得授权码后查看原文';
  }
}

function play(){audio.play()} 
function toggle(){audio.paused?audio.play():audio.pause()} 
function prev(){if(idx>0){loadIndex(idx-1); play();}} 
function next(){if(idx<segments.length-1){loadIndex(idx+1); play();}}

// 事件监听
document.getElementById('loadDefault').addEventListener('click', loadDefaultMaterials);
document.getElementById('loadCustom').addEventListener('click', ()=>{document.getElementById('customSection').style.display='block'});
document.getElementById('loadFiles').addEventListener('click', loadFiles);
document.getElementById('clear').addEventListener('click', ()=>{segments=[]; idx=-1; renderList(); audio.removeAttribute('src'); bar.style.width='0%'; document.getElementById('nowLabel').textContent='—'; document.getElementById('nowIdx').textContent=''; document.getElementById('nowRange').textContent='—'; completedSentences.clear(); updateCompletionStatus();});
document.getElementById('rate').addEventListener('change', e=>{ audio.playbackRate=parseFloat(e.target.value); });
document.getElementById('toggle').addEventListener('click', toggle);
document.getElementById('prev').addEventListener('click', prev);
document.getElementById('next').addEventListener('click', next);
document.getElementById('repeat3').addEventListener('click', ()=>{ repeatLeft=3; play(); });
document.getElementById('studentAnswer').addEventListener('input', e=>{ if(idx>=0) localStorage.setItem(`answer_${idx}`, e.target.value); });
document.getElementById('markComplete').addEventListener('click', ()=>{ if(idx>=0) { completedSentences.add(idx); localStorage.setItem(`completed_${idx}`, 'true'); renderList(); updateCompletionStatus(); alert('已标记本句为完成！'); } });
document.getElementById('clozeLevel').addEventListener('input', updateClozeHint);
document.getElementById('showClozeHint').addEventListener('click', ()=>{ document.getElementById('clozePanel').style.display = document.getElementById('clozePanel').style.display === 'none' ? '' : 'none'; });
document.getElementById('printWorksheet').addEventListener('click', printClozeWorksheet);

audio.addEventListener('timeupdate', ()=>{ if(idx<0) return; const seg=segments[idx]; const pct=(audio.currentTime-seg.start)/(seg.end-seg.start)*100; bar.style.width=Math.max(0,Math.min(100,pct))+'%'; if(audio.currentTime>=seg.end-0.01){ if(document.getElementById('loopOne').checked){ audio.currentTime=seg.start; audio.play(); return;} if(repeatLeft>1){repeatLeft--; audio.currentTime=seg.start; audio.play(); return;} repeatLeft=0; if(document.getElementById('autoNext').checked){ next(); } } });

// 导出功能
function floatTo16BitPCM(float32){ const out=new Int16Array(float32.length); for(let i=0;i<float32.length;i++){ let s=Math.max(-1,Math.min(1,float32[i])); out[i]=s<0?s*0x8000:s*0x7FFF; } return out; }
function encodeWAV(interleaved, sampleRate, numChannels){ const bytesPerSample=2; const blockAlign=numChannels*bytesPerSample; const buffer=new ArrayBuffer(44+interleaved.length*bytesPerSample); const view=new DataView(buffer); let o=0; const w8=v=>{view.setUint8(o++,v)}; const w32=v=>{view.setUint32(o,v,true); o+=4}; const w16=v=>{view.setUint16(o,v,true); o+=2}; 'RIFF'.split('').forEach(ch=>w8(ch.charCodeAt(0))); w32(36+interleaved.length*bytesPerSample); 'WAVEfmt '.split('').forEach(ch=>w8(ch.charCodeAt(0))); w32(16); w16(1); w16(numChannels); w32(sampleRate); w32(sampleRate*blockAlign); w16(blockAlign); w16(8*bytesPerSample); 'data'.split('').forEach(ch=>w8(ch.charCodeAt(0))); w32(interleaved.length*bytesPerSample); const pcm=floatTo16BitPCM(interleaved); for(let i=0;i<pcm.length;i++){ view.setInt16(o, pcm[i], true); o+=2;} return new Blob([view], {type:'audio/wav'}); }
function sliceToWav(buffer, startSec, endSec){ const sr=buffer.sampleRate; const ch=buffer.numberOfChannels; const a=Math.max(0,Math.floor(startSec*sr)); const b=Math.min(buffer.length, Math.floor(endSec*sr)); const frames=Math.max(0,b-a); if(frames<=0) return null; const channels=[]; for(let c=0;c<ch;c++){ const data=buffer.getChannelData(c).subarray(a,b); channels.push(data); } const interleaved=new Float32Array(frames*ch); for(let i=0;i<frames;i++){ for(let c=0;c<ch;c++){ interleaved[i*ch+c]=channels[c][i]||0; } } return encodeWAV(interleaved, sr, ch); }
function downloadBlob(blob, filename){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),5000); }
function exportCurrent(){ if(!decodedBuffer){ alert('当前浏览器未完成音频解码，无法导出。请重新载入文件后再试。'); return; } if(idx<0){ alert('请先载入并选择一个句子'); return; } const seg=segments[idx]; const wav=sliceToWav(decodedBuffer, seg.start, seg.end); if(!wav){ alert('导出失败：切片为空'); return; } downloadBlob(wav, `${seg.label}.wav`); }
document.getElementById('exportClip').addEventListener('click', exportCurrent);
window.addEventListener('keydown', e=>{ if(e.key==='e'||e.key==='E'){ exportCurrent(); } });

// 初始化
initAuth();

// 预加载已完成状态
function loadCompletedSentences() {
  for(let i = 0; i < 100; i++) {
    if(localStorage.getItem(`completed_${i}`)) {
      completedSentences.add(i);
    }
  }
}
loadCompletedSentences();
</script>
</body>
</html>