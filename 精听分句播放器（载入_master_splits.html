<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>精听分句播放器 · 本地 master + splits.csv</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937;--card:#0b1220;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
    header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    header h1{margin:0;font-size:18px}
    .muted{color:var(--muted);font-size:12px}
    main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
    @media (max-width:960px){main{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .col{display:flex;flex-direction:column;gap:8px}
    input[type="file"],select,button{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:14px}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:#1d4ed8}
    button.ghost{background:var(--card)}
    .list{max-height:60vh;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .item{display:grid;grid-template-columns:70px 1fr auto;gap:8px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px}
    .item.active{outline:2px solid #3b82f6}
    .progress{height:8px;width:100%;background:var(--card);border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#3b82f6)}
    textarea{width:100%;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px;line-height:1.6}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--card);border:1px solid var(--border);border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
<header>
  <h1>精听分句播放器</h1>
  <span class="muted">本地运行 · 加载 master 音频 + splits.csv（start,end,label）</span>
  <div style="flex:1"></div>
  <span class="muted">快捷键：<span class="kbd">Space</span> 播放/暂停 · <span class="kbd">←/→</span> 上/下一句 · <span class="kbd">L</span> 单句循环 · <span class="kbd">A/D</span> 变速 · <span class="kbd">N</span> 自动下一句</span>
</header>

<main>
  <section class="panel">
    <div class="col">
      <div class="row"><strong>1) 选择 master 音频</strong></div>
      <input id="fileAudio" type="file" accept="audio/*,video/*" />
      <div class="row"><strong>2) 选择 splits.csv</strong> <span class="muted">（三列：start,end,label；支持 00:01:12.345、01:12、72.345）</span></div>
      <input id="fileCSV" type="file" accept=".csv,text/csv" />
      <div class="row"><button id="load" class="primary">载入</button><button id="clear" class="ghost">清空</button></div>
      <hr style="border-color:#1f2937;opacity:.4"/>
      <div class="row" style="justify-content:space-between;align-items:center"><strong>句子列表</strong><span class="muted" id="count">0 条</span></div>
      <div id="list" class="list"></div>
    </div>
  </section>

  <section class="panel">
    <div class="row" style="justify-content:space-between">
      <div>
        <div>当前：<span id="nowLabel">—</span> <span class="muted" id="nowIdx"></span></div>
        <div class="muted">起止：<span id="nowRange">—</span></div>
      </div>
      <div class="row">
        <label class="muted">速度
          <select id="rate">
            <option value="0.7">0.7×</option>
            <option value="0.85">0.85×</option>
            <option value="1" selected>1.0×</option>
            <option value="1.2">1.2×</option>
            <option value="1.5">1.5×</option>
            <option value="2">2.0×</option>
          </select>
        </label>
        <label class="muted"><input id="loopOne" type="checkbox"> 单句循环 (L)</label>
        <label class="muted"><input id="autoNext" type="checkbox" checked> 自动下一句 (N)</label>
      </div>
    </div>

    <audio id="audio" controls style="width:100%;margin:10px 0 8px 0"></audio>
    <div class="progress"><div id="bar" class="bar"></div></div>

    <div class="row" style="justify-content:center;margin-top:10px;gap:12px">
      <button id="prev" class="ghost">← 上一句</button>
      <button id="toggle" class="ghost">▶︎ 播放/暂停</button>
      <button id="next" class="ghost">下一句 →</button>
      <button id="repeat3" class="ghost">重复 3 次</button>
      <button id="exportCSV" class="ghost">导出空白听写表</button>
    </div>

    <div class="panel" style="margin-top:16px">
      <div style="font-weight:600;margin-bottom:6px">当前句原文（可编辑，随页面保存到内存）</div>
      <textarea id="text" rows="6" placeholder="在这里写当前句的脚本/关键词/易错点"></textarea>
    </div>
  </section>
</main>

<script>
let segments = []; // {start,end,label,text}
let idx = -1;      // current index
let repeatLeft = 0;
const audio = document.getElementById('audio');
const bar = document.getElementById('bar');

function parseTime(s){
  if(typeof s === 'number') return s;
  s = String(s).trim();
  if(!s) return 0;
  if(/^\d+(\.\d+)?$/.test(s)) return parseFloat(s); // plain seconds
  // HH:MM:SS(.ms) or MM:SS(.ms)
  const parts = s.split(':').map(parseFloat);
  if(parts.length === 2){
    const [m, sec] = parts; return m*60 + sec;
  }
  if(parts.length === 3){
    const [h, m, sec] = parts; return h*3600 + m*60 + sec;
  }
  return 0;
}

function fmt(t){
  if(t<0) t=0; const h=Math.floor(t/3600); const m=Math.floor((t%3600)/60); const s=(t%60).toFixed(3).padStart(6,'0');
  return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s}`;
}

async function loadFiles(){
  const a = document.getElementById('fileAudio').files[0];
  const c = document.getElementById('fileCSV').files[0];
  if(!a || !c){ alert('请先选择 master 音频和 splits.csv'); return; }

  // load audio
  audio.src = URL.createObjectURL(a);

  // parse csv
  const text = await c.text();
  const lines = text.split(/\r?\n/).filter(x=>x.trim());
  const out = [];
  for(const line of lines){
    const cells = line.split(',');
    if(cells.length < 3) continue;
    const start = parseTime(cells[0]);
    const end = parseTime(cells[1]);
    const label = cells.slice(2).join(',').trim().replace(/^\"|\"$/g,'');
    if(!isFinite(start) || !isFinite(end) || end<=start) continue;
    out.push({start, end, label, text:''});
  }
  segments = out;
  if(!segments.length){ alert('CSV 解析为空，请检查是否为三列：start,end,label'); return; }
  idx = 0; renderList(); loadIndex(0);
}

function renderList(){
  const list = document.getElementById('list');
  list.innerHTML = '';
  document.getElementById('count').textContent = `${segments.length} 条`;
  segments.forEach((seg,i)=>{
    const div = document.createElement('div');
    div.className = 'item' + (i===idx? ' active':'');
    div.innerHTML = `
      <span class="muted">#${String(i+1).padStart(2,'0')}</span>
      <div>${seg.label} <span class="muted">(${fmt(seg.start)} ~ ${fmt(seg.end)})</span></div>
      <button class="ghost">播放</button>
    `;
    div.querySelector('button').addEventListener('click', ()=>{loadIndex(i); play();});
    div.addEventListener('click', (e)=>{ if(e.target.tagName!=='BUTTON'){ loadIndex(i); }});
    list.appendChild(div);
  });
}

function loadIndex(i){
  if(i<0||i>=segments.length) return;
  idx = i; repeatLeft = 0;
  const seg = segments[idx];
  audio.currentTime = seg.start;
  document.getElementById('nowLabel').textContent = seg.label;
  document.getElementById('nowIdx').textContent = `(${idx+1}/${segments.length})`;
  document.getElementById('nowRange').textContent = `${fmt(seg.start)} ~ ${fmt(seg.end)}`;
  document.getElementById('text').value = seg.text || '';
  [...document.querySelectorAll('.item')].forEach((el,j)=>el.classList.toggle('active', j===idx));
}

function prev(){ if(idx>0){ loadIndex(idx-1); play(); }}
function next(){ if(idx<segments.length-1){ loadIndex(idx+1); play(); }}
function play(){ audio.play(); }
function toggle(){ audio.paused ? audio.play() : audio.pause(); }

// events
 document.getElementById('load').addEventListener('click', loadFiles);
 document.getElementById('clear').addEventListener('click', ()=>{segments=[]; idx=-1; renderList(); audio.removeAttribute('src'); bar.style.width='0%'; document.getElementById('nowLabel').textContent='—'; document.getElementById('nowIdx').textContent=''; document.getElementById('nowRange').textContent='—';});
 document.getElementById('rate').addEventListener('change', e=>{ audio.playbackRate = parseFloat(e.target.value); });
 document.getElementById('toggle').addEventListener('click', toggle);
 document.getElementById('prev').addEventListener('click', prev);
 document.getElementById('next').addEventListener('click', next);
 document.getElementById('repeat3').addEventListener('click', ()=>{ repeatLeft = 3; play(); });
 document.getElementById('text').addEventListener('input', e=>{ if(idx>=0) segments[idx].text = e.target.value; });
 document.getElementById('exportCSV').addEventListener('click', ()=>{
   const rows = segments.map(s=> `${JSON.stringify(s.label)},`);
   const csv = 'label,answer\n' + rows.join('\n');
   const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
   const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='dictation_blank.csv'; a.click();
 });

 audio.addEventListener('timeupdate', ()=>{
   if(idx<0) return; const seg = segments[idx];
   const pct = (audio.currentTime - seg.start) / (seg.end - seg.start) * 100; bar.style.width = Math.max(0, Math.min(100, pct)) + '%';
   if(audio.currentTime >= seg.end - 0.01){
     if(document.getElementById('loopOne').checked){ audio.currentTime = seg.start; audio.play(); return; }
     if(repeatLeft>1){ repeatLeft--; audio.currentTime = seg.start; audio.play(); return; }
     repeatLeft = 0; if(document.getElementById('autoNext').checked){ next(); }
   }
 });

 // hotkeys
 window.addEventListener('keydown', (e)=>{
   if(['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)){
     if(e.code==='Space'){ e.preventDefault(); toggle(); } return; }
   if(e.code==='Space'){ e.preventDefault(); toggle(); }
   else if(e.code==='ArrowLeft'){ prev(); }
   else if(e.code==='ArrowRight'){ next(); }
   else if(e.key==='l'||e.key==='L'){ document.getElementById('loopOne').checked = !document.getElementById('loopOne').checked; }
   else if(e.key==='n'||e.key==='N'){ const el=document.getElementById('autoNext'); el.checked=!el.checked; }
   else if(e.key==='a'||e.key==='A'){ audio.playbackRate=Math.max(0.5,Math.round((audio.playbackRate-0.1)*10)/10); document.getElementById('rate').value=String(audio.playbackRate); }
   else if(e.key==='d'||e.key==='D'){ audio.playbackRate=Math.min(2,Math.round((audio.playbackRate+0.1)*10)/10); document.getElementById('rate').value=String(audio.playbackRate); }
 });
</script>
</body>
</html>